Ansible-Tower自动化运维管理环境 - 安装破解记录

 

公司中实现运维自动化的架构中主要用到ansible，ansible脚本在部署服务器指令行中显得不太直观。Ansible-Tower（之前叫做awx）是将ansible的指令界面化，简明直观，简单易用。Ansibke-tower其实就是一个图形化的任务调度，复杂服务部署，IT自动化的一个管理平台，属于发布配置管理系统，支持Api及界面操作，Django编写。Ansible-tower可以通过界面从github拉取最新playbook实施服务部署，提高生产效率。当然它也提供一个RESET API和命令行的CLI以供python脚本调用。下面是Ansible-Tower的搭建记录，在此分享下：

|   |   |
| - | - |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62 | Ansible-Tower目前支持7.4+的版本，可以使用yum update -y命令更新；<br>    <br>1. 安装Ansible的epel源<br>[root@ansible ~]\# cat /etc/redhat-release<br>CentOS Linux release 7.5.1804 (Core)<br>    <br>[root@ansible ~]\# python -V<br>Python 2.7.5<br>   <br>关闭selinux<br>[root@ansible ansible-tower]\# vim /etc/sysconfig/selinux<br>.........<br>SELINUX=disabled<br>[root@ansible ansible-tower]\# setenforce 0<br>setenforce: SELinux is disabled<br>[root@ansible ansible-tower]\# getenforce<br>Disabled<br>   <br>关闭防火墙<br>[root@ansible ansible-tower]\# systemctl stop firewalld <br>[root@ansible ansible-tower]\# systemctl disable firewalld<br>[root@ansible ansible-tower]\# firewall-cmd --state<br>not running<br>   <br>========================================================================================================<br>需要注意：如果开启了防火墙，需要开放对应访问策略（这里是测试环境，就关闭了防火墙）<br>[root@ansible ansible-tower]\# firewall-cmd --permanent --zone=public --add-port=80/tcp<br>[root@ansible ansible-tower]\# systemctl restart firewalld.service<br>========================================================================================================<br>   <br>2. 安装Ansible<br>[root@ansible ~]\# yum install -y ansible<br>[root@ansible ~]\# ansible --version<br>ansible 2.8.2<br>  config file = /etc/ansible/ansible.cfg<br>  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']<br>  ansible python module location = /usr/lib/python2.7/site-packages/ansible<br>  executable location = /usr/bin/ansible<br>  python version = 2.7.5 (default, Jun 20 2019, 20:27:34) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]<br>   <br>3. 按照ansible-tower（官网下载地址: https://releases.ansible.com/ansible-tower/setup/）<br>下载地址：https://pan.baidu.com/s/1Uz-BFZXkjOr4FLg-lFF4fQ<br>提取密码：3e97<br>   <br>[root@ansible ~]\# cd /usr/local/src/<br>[root@ansible src]\# wget https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-3.2.6-1.el7.tar.gz<br>[root@ansible src]\# tar -zvxf ansible-tower-setup-bundle-3.2.6-1.el7.tar.gz<br>[root@ansible src]\# mv ansible-tower-setup-bundle-3.2.6-1.el7 /usr/local/ansible-tower<br>[root@ansible src]\# cd /usr/local/ansible-tower<br>[root@ansible ansible-tower]\# ls<br>backup.yml  bundle  group\_vars  install.yml  inventory  licenses  README.md  restore.yml  roles  setup.sh<br>   <br>配置inventory文件 (注意：admin\_password处填写的就是ansible-tower登陆密码，密码可以自行设定)<br>[root@ansible ansible-tower]\# sed -i "s\#password=''\#password='tower@123'\#g" inventory   <br>[root@ansible ansible-tower]\# sed -i "s\#host=''\#host='127.0.0.1'\#g" inventory<br>[root@ansible ansible-tower]\# sed -i "s\#port=''\#port='5432'\#g" inventory<br>   <br>安装前先创建/var/log/tower的日志目录，不然会报错<br>[root@ansible ansible-tower]\# mkdir -p /var/log/tower<br>   <br>接着执行ansible-tower的安装脚本，如果网络没有问题的话耐心等待安装完成即可.<br>[root@ansible ansible-tower]\# ./setup.sh |


安装完成没报错的话即可访问web页面,这里测试机地址为172.16.60.244，则访问ansible-tower地址就是https://172.16.60.244, 默认初始页面如下:

![](images/5F61F251988145CBB3745E9C0E8883D903-908595455.png)

![](images/68687F9A50694EE494BB32C31F46ABA93-1169192574.png)

默认用户为admin，密码为inventory文件admin_password字段配置的密码（如上设置的密码为"tower@123")。接着会提示让选择license文件，导入license，没有的话,点击REQUEST LICENSE，去官方 (https://www.ansible.com/license) 申请免费试用，填写个人信息后 (邮箱要填写正确,其他信息可随便填写) 会把license发到填写的邮箱。这里分享一个已经申请下来的license文件  (提取密码为: krwe)。提交license并登录成功后默认初始页面如下:

![](images/A8D43322F408490498B6F3A9E1C136D5565-21098718.png)

![](images/4508547466C642EE98901B2930F5DF3944-359254794.png)

申请的免费版license最多只能添加10个主机, 且有时间限制。 下面记录下破解方法：

|   |   |
| - | - |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37 | [root@k8s-node01 ansible-tower]\# cd /var/lib/awx/venv/awx/lib/python2.7/site-packages/tower\_license<br>[root@k8s-node01 tower\_license]\# ll<br>total 28<br>-rw-r--r-- 1 root root 10417 Aug 11  2018 \_\_init\_\_.py<br>-rw-r--r-- 1 root root  6352 Aug 11  2018 \_\_init\_\_.pyc<br>-rw-r--r-- 1 root root  6352 Aug 11  2018 \_\_init\_\_.pyo<br> <br>修改\_\_init\_\_.py文件<br>将119行和120行修改为如下内容,特别需要注意格式.<br>也就是在原文119和120行之间添加了一行"return True"内容，格式对齐即可 (即加入的"return True" 跟 后面的if语句保持对齐，不然后面重新编译会报错)。<br>[root@k8s-node01 tower\_license]\# vim \_\_init\_\_.py<br>.........<br>119     def \_check\_cloudforms\_subscription(self):<br>120         return True<br>121         if os.path.exists('/var/lib/awx/i18n.db'):<br>122             return True<br>123         if os.path.isdir("/opt/rh/cfme-appliance") and os.path.isdir("/opt/rh/cfme-gemset"):<br>124             try:<br>.........<br> <br>修改完重新编译一下:<br>[root@k8s-node01 tower\_license]\# python -m py\_compile \_\_init\_\_.py<br>[root@k8s-node01 tower\_license]\# python -O -m py\_compile \_\_init\_\_.py<br>[root@k8s-node01 tower\_license]\#<br> <br>重启服务:<br>[root@k8s-node01 tower\_license]\# ansible-tower-service restart<br>Restarting Tower<br>Redirecting to /bin/systemctl stop postgresql-9.6.service<br>Redirecting to /bin/systemctl stop rabbitmq-server.service<br>Redirecting to /bin/systemctl stop nginx.service<br>Redirecting to /bin/systemctl stop supervisord.service<br>Redirecting to /bin/systemctl start postgresql-9.6.service<br>Redirecting to /bin/systemctl start rabbitmq-server.service<br>Redirecting to /bin/systemctl start nginx.service<br>Redirecting to /bin/systemctl start supervisord.service<br>[root@k8s-node01 tower\_license]\# |


重新打开ansible-tower界面的"settings"–>"VIEW YOUR LICENSE"，发现"Hosts Available"变成了9999999台,说明破解成功,如下:

![](images/4A324410616D48A0871ECE712DEE4A1689-101444412.png)

                                                                                                                                              

需要注意：发现最新版本或者高版本的ansible-tower没有__init__.py文件，需要对__init__.pyc进行反编译，然后进行HOSTS限制破解操作：

|   |   |
| - | - |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62 | 比如下载ansible-tower-setup-latest.tar.gz最新的包，按照上面的按照部署，将ansible-tower部署到/usr/local目录下<br>[root@ansible ~]\# python --version<br>Python 2.7.5<br> <br>[root@ansible ~]\# cd /var/lib/awx/venv/awx/lib/python3.6/site-packages/tower\_license<br>[root@ansible tower\_license]\# ll<br>total 8<br>-rw-r--r-- 1 root root 5055 Aug 12 21:13 \_\_init\_\_.pyc<br>drwxr-xr-x 2 root root   37 Aug 22 15:19 \_\_pycache\_\_<br> <br>1）接下来进行反汇编init.pyc<br>[root@ansible tower\_license]\# yum install python-pip<br>[root@ansible tower\_license]\# pip -V<br>pip 8.1.2 from /usr/lib/python2.7/site-packages (python 2.7)<br> <br>[root@ansible tower\_license]\# pip install uncompyle6<br>[root@ansible tower\_license]\# uncompyle6 --version<br>uncompyle6 3.3.5<br> <br>[root@ansible tower\_license]\# uncompyle6 \_\_init\_\_.pyc &gt;\_\_init\_\_.py<br>[root@ansible tower\_license]\# ll<br>total 16<br>-rw-r--r-- 1 root root 7301 Aug 22 15:42 \_\_init\_\_.py<br>-rw-r--r-- 1 root root 5055 Aug 12 21:13 \_\_init\_\_.pyc<br>drwxr-xr-x 2 root root   37 Aug 22 15:19 \_\_pycache\_\_<br> <br>2）修改\_\_init\_\_.py文件<br>[root@ansible tower\_license]\# vim \_\_init\_\_.py<br>........<br>\# \_check\_cloudforms\_subscription方法修改如下内容,特别需要注意格式。<br>    def \_check\_cloudforms\_subscription(self):<br>\# 只需要添加下面一行直接返回 True即可。注意格式要跟if对对齐。<br>        return True<br>        if os.path.exists('/var/lib/awx/i18n.db'):<br>            return True<br>        else:<br>            if os.path.isdir('/opt/rh/cfme-appliance'):<br>                if os.path.isdir('/opt/rh/cfme-gemset'):<br>                    pass<br>            try:<br>........<br> <br>\#修改"license\_date=253370764800L" 为 "license\_date=253370764800"<br>........<br> <br>    def \_generate\_cloudforms\_subscription(self):<br>        self.\_attrs.update(dict(company\_name='Red Hat CloudForms License', instance\_count=9999999,<br>          license\_date=253370764800,            \# 只需要修改这一行<br>          license\_key='xxxx',<br>          license\_type='enterprise',<br>          subscription\_name='Red Hat CloudForms License'))<br>........<br> <br>3）修改完重新编译一下<br>[root@ansible tower\_license]\# python -m py\_compile \_\_init\_\_.py<br>[root@ansible tower\_license]\# python -O -m py\_compile \_\_init\_\_.py<br>[root@ansible tower\_license]\#<br> <br>4）重启服务<br>[root@ansible tower\_license]\# ansible-tower-service restart<br> <br>5）最后打开url (https://your\_ip/\#/license) ,发现"Hosts Available"变成了"9999999"台, 到期时间变成了"01/01/9999", 说明破解成功了。 |


*************** 当你发现自己的才华撑不起野心时，就请安静下来学习吧！***************