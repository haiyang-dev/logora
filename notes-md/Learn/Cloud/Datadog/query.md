### ç¤ºä¾‹æ•°æ®

å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹Â qe_health_statusÂ æŒ‡æ ‡æ•°æ®ï¼ˆæ¯åˆ†é’Ÿä¸¤ä¸ªæ•°æ®ç‚¹ï¼‰ï¼š

```
æ—¶é—´æˆ³       | pod_name | qe_health_status
------------------------------------------
16:00:00     | pod1     | 1
16:00:30     | pod1     | 2
16:01:00     | pod1     | 3
16:01:30     | pod1     | 4
16:02:00     | pod1     | 5
16:02:30     | pod1     | 6
16:03:00     | pod1     | 7
16:03:30     | pod1     | 8
16:04:00     | pod1     | 9
16:04:30     | pod1     | 10

```

### ç®€å•æ¥è¯´ï¼Œ

.rollup(sum, 60)Â å¼ºåˆ¶å°†æ•°æ®æŒ‰60ç§’çš„é—´éš”è¿›è¡Œæ±‡æ€»ï¼Œè€Œæ²¡æœ‰Â .rollup(sum, 60)Â çš„æŸ¥è¯¢ä¼šæ ¹æ®Datadogçš„é»˜è®¤è®¾ç½®è¿›è¡Œæ±‡æ€»

åœ¨Datadogä¸­ï¼Œé»˜è®¤çš„æ±‡æ€»æ—¶é—´é—´éš”å¹¶ä¸æ˜¯å›ºå®šçš„60ç§’ï¼Œè€Œæ˜¯æ ¹æ®å…·ä½“çš„æŸ¥è¯¢å’Œæ•°æ®æºçš„ä¸åŒï¼Œæ•°æ®çš„ç²’åº¦å’ŒæŸ¥è¯¢çš„æ—¶é—´èŒƒå›´è€Œå˜åŒ–è€Œæœ‰æ‰€å˜åŒ–

**æŸ¥è¯¢è¯­å¥1**

```
avg(last_4m):sum:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(sum, 60) >= 3
```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ æ±‚å’Œï¼š

- 16:00:00: 1 + 2 = 3

- 16:01:00: 3 + 4 = 7

- 16:02:00: 5 + 6 = 11

- 16:03:00: 7 + 8 = 15

- 16:04:00: 9 + 10 = 19

æ¯åˆ†é’Ÿçš„æ»šåŠ¨æ±‚å’Œï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 3

- 16:01:00: 7

- 16:02:00: 11

- 16:03:00: 15

- 16:04:00: 19

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 3
16:01:00     | pod1     | 7
16:02:00     | pod1     | 11
16:03:00     | pod1     | 15
16:04:00     | pod1     | 19

```

### æŸ¥è¯¢è¯­å¥2

```
avg(last_4m):sum:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(avg, 60) >= 3
.rollup(avg, 60)Â ä¸ä¼šè¦†ç›–å‰é¢çš„Â sumï¼Œè€Œæ˜¯å¯¹æ¯ä¸ª60ç§’æ—¶é—´æ®µå†…çš„æ±‚å’Œç»“æœè¿›è¡Œå¹³å‡å€¼è®¡ç®—
```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ æ±‚å’Œï¼š

- 16:00:00: 1 + 2 = 3

- 16:01:00: 3 + 4 = 7

- 16:02:00: 5 + 6 = 11

- 16:03:00: 7 + 8 = 15

- 16:04:00: 9 + 10 = 19

æ¯åˆ†é’Ÿçš„æ»šåŠ¨å¹³å‡ï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 3 / 2 = 1.5

- 16:01:00: 7 / 2 = 3.5

- 16:02:00: 11 / 2 = 5.5

- 16:03:00: 15 / 2 = 7.5

- 16:04:00: 19 / 2 = 9.5

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨å¹³å‡
--------------------------------
16:00:00     | pod1     | 1.5
16:01:00     | pod1     | 3.5
16:02:00     | pod1     | 5.5
16:03:00     | pod1     | 7.5
16:04:00     | pod1     | 9.5

```

### æŸ¥è¯¢è¯­å¥3

```
avg(last_4m):avg:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(sum, 60) >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ å¹³å‡å€¼ï¼š

- 16:00:00: (1 + 2) / 2 = 1.5

- 16:01:00: (3 + 4) / 2 = 3.5

- 16:02:00: (5 + 6) / 2 = 5.5

- 16:03:00: (7 + 8) / 2 = 7.5

- 16:04:00: (9 + 10) / 2 = 9.5

æ¯åˆ†é’Ÿçš„æ»šåŠ¨æ±‚å’Œï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 1.5

- 16:01:00: 3.5

- 16:02:00: 5.5

- 16:03:00: 7.5

- 16:04:00: 9.5

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 1.5
16:01:00     | pod1     | 3.5
16:02:00     | pod1     | 5.5
16:03:00     | pod1     | 7.5
16:04:00     | pod1     | 9.5

```

### æŸ¥è¯¢è¯­å¥4

```
avg(last_4m):avg:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(avg, 60) >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ å¹³å‡å€¼ï¼š

- 16:00:00: (1 + 2) / 2 = 1.5

- 16:01:00: (3 + 4) / 2 = 3.5

- 16:02:00: (5 + 6) / 2 = 5.5

- 16:03:00: (7 + 8) / 2 = 7.5

- 16:04:00: (9 + 10) / 2 = 9.5

æ¯åˆ†é’Ÿçš„æ»šåŠ¨å¹³å‡ï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 1.5

- 16:01:00: 3.5

- 16:02:00: 5.5

- 16:03:00: 7.5

- 16:04:00: 9.5

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨å¹³å‡
--------------------------------
16:00:00     | pod1     | 1.5
16:01:00     | pod1     | 3.5
16:02:00     | pod1     | 5.5
16:03:00     | pod1     | 7.5
16:04:00     | pod1     | 9.5
```

### æŸ¥è¯¢è¯­å¥5

```
avg(last_4m):sum:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(sum, 30) >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ æ±‚å’Œï¼š

- 16:00:00: 1

- 16:00:30: 2

- 16:01:00: 3

- 16:01:30: 4

- 16:02:00: 5

- 16:02:30: 6

- 16:03:00: 7

- 16:03:30: 8

- 16:04:00: 9

- 16:04:30: 10

æ¯30ç§’çš„æ»šåŠ¨æ±‚å’Œï¼š

- 16:00:00: 1

- 16:00:30: 2

- 16:01:00: 3

- 16:01:30: 4

- 16:02:00: 5

- 16:02:30: 6

- 16:03:00: 7

- 16:03:30: 8

- 16:04:00: 9

- 16:04:30: 10

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 1
16:00:30     | pod1     | 2
16:01:00     | pod1     | 3
16:01:30     | pod1     | 4
16:02:00     | pod1     | 5
16:02:30     | pod1     | 6
16:03:00     | pod1     | 7
16:03:30     | pod1     | 8
16:04:00     | pod1     | 9
16:04:30     | pod1     | 10

```

### æŸ¥è¯¢è¯­å¥6

```
avg(last_4m):sum:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name} >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ æ±‚å’Œï¼š

- 16:00:00: 1 + 2 = 3

- 16:01:00: 3 + 4 = 7

- 16:02:00: 5 + 6 = 11

- 16:03:00: 7 + 8 = 15

- 16:04:00: 9 + 10 = 19

æ¯åˆ†é’Ÿçš„æ±‚å’Œï¼ˆé»˜è®¤æ—¶é—´çª—å£1åˆ†é’Ÿï¼‰ï¼š

- 16:00:00: 3

- 16:01:00: 7

- 16:02:00: 11

- 16:03:00: 15

- 16:04:00: 19

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 3
16:01:00     | pod1     | 7
16:02:00     | pod1     | 11
16:03:00     | pod1     | 15
16:04:00     | pod1     | 19

```

### æŸ¥è¯¢è¯­å¥7

```
sum(last_4m):sum:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(sum, 60) >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ æ±‚å’Œï¼š

- 16:00:00: 1 + 2 = 3

- 16:01:00: 3 + 4 = 7

- 16:02:00: 5 + 6 = 11

- 16:03:00: 7 + 8 = 15

- 16:04:00: 9 + 10 = 19

æ¯åˆ†é’Ÿçš„æ»šåŠ¨æ±‚å’Œï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 3

- 16:01:00: 7

- 16:02:00: 11

- 16:03:00: 15

- 16:04:00: 19

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 3
16:01:00     | pod1     | 7
16:02:00     | pod1     | 11
16:03:00     | pod1     | 15
16:04:00     | pod1     | 19

```

### æŸ¥è¯¢è¯­å¥8

```
sum(last_4m):avg:a552014_ets_qe_${var.environment}_otlp.qe_health_status{region:${var.region},otellib:ets-qe-meter} by {pod_name}.rollup(sum, 60) >= 3

```

**è§£é‡Š**:

è¿‡å»4åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹ï¼š16:00:00 åˆ° 16:04:30

æ¯åˆ†é’Ÿçš„Â qe_health_statusÂ å¹³å‡å€¼ï¼š

- 16:00:00: (1 + 2) / 2 = 1.5

- 16:01:00: (3 + 4) / 2 = 3.5

- 16:02:00: (5 + 6) / 2 = 5.5

- 16:03:00: (7 + 8) / 2 = 7.5

- 16:04:00: (9 + 10) / 2 = 9.5

æ¯åˆ†é’Ÿçš„æ»šåŠ¨æ±‚å’Œï¼ˆ60ç§’ï¼‰ï¼š

- 16:00:00: 1.5

- 16:01:00: 3.5

- 16:02:00: 5.5

- 16:03:00: 7.5

- 16:04:00: 9.5

**æ§åˆ¶å°è¾“å‡º**:

```
æ—¶é—´æˆ³       | pod_name | æ»šåŠ¨æ±‚å’Œ
--------------------------------
16:00:00     | pod1     | 1.5
16:01:00     | pod1     | 3.5
16:02:00     | pod1     | 5.5
16:03:00     | pod1     | 7.5
16:04:00     | pod1     | 9.5
```

### avgå‰ç¼€

sum(last_4m):avg:system.cpu.user{region:us-east}

è¿™è¡¨ç¤ºï¼š

1. **avg:**ï¼šå¯¹ host1ã€host2ã€host3 åœ¨æ¯ä¸ªæ—¶é—´ç‚¹çš„å€¼å–å¹³å‡ â†’ å¾—åˆ°ä¸€ä¸ªå¹³å‡æ—¶é—´åºåˆ—ã€‚

1. **sum(last_4m):**ï¼šå¯¹è¿™ä¸ªå¹³å‡æ—¶é—´åºåˆ—ï¼Œåœ¨è¿‡å» 4 åˆ†é’Ÿå†…çš„æ‰€æœ‰ç‚¹æ±‚å’Œ â†’ å¾—åˆ°ä¸€ä¸ªå•ä¸€å€¼ã€‚

| èšåˆå±‚çº§ | ç¤ºä¾‹ | èšåˆæ–¹å‘ | ç»“æœç±»å‹ | è¯´æ˜ | 
| -- | -- | -- | -- | -- |
| ç©ºé—´èšåˆ | avg: | æ¨ªå‘ï¼ˆ | æ—¶é—´åºåˆ— | å¤šä¸ªæ—¶é—´åºåˆ— â†’ ä¸€ä¸ªæ—¶é—´åºåˆ— | 
| æ—¶é—´èšåˆ | sum(last_4m): | çºµå‘ï¼ˆ | å•ä¸€å€¼æˆ–ä½é¢‘åºåˆ— | ä¸€ä¸ªæ—¶é—´åºåˆ— â†’ å•ä¸€å€¼æˆ–æ›´ç²—ç²’åº¦åºåˆ— | 


### æ‹¬å·è¡¨ç¤ºâ€œ**æ—¶é—´çª—å£èšåˆ**â€ï¼

Datadog çš„èšåˆå‡½æ•°æœ‰ä¸¤ç§å½¢å¼ï¼š

#### âœ… 1.Â **ä¸å¸¦æ‹¬å·çš„èšåˆå‰ç¼€ï¼ˆå¦‚Â ****avg:****ã€****sum:****ï¼‰**

- ä½œç”¨ï¼š**åœ¨æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œå¯¹å¤šä¸ªæ—¶é—´åºåˆ—è¿›è¡Œèšåˆ**ã€‚

- èšåˆæ–¹å‘ï¼š**æ¨ªå‘ï¼ˆç©ºé—´èšåˆï¼‰**

- avg:system.cpu.user{host:host1,host2} â†’ æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œå¯¹ host1 å’Œ host2 çš„å€¼å–å¹³å‡ï¼Œç»“æœæ˜¯æŠŠå¤šä¸ªæ—¶é—´åºåˆ—åˆå¹¶æˆä¸€ä¸ªæ—¶é—´åºåˆ—ã€‚

- å®ƒçš„ä½œç”¨æ˜¯ï¼š**åœ¨æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œå¯¹æ‰€æœ‰åŒ¹é…çš„æ—¶é—´åºåˆ—ï¼ˆä¾‹å¦‚å¤šä¸ªä¸»æœºã€Pod(å¤šä¸ªmetric?)ï¼‰è¿›è¡Œèšåˆ**ã€‚

- æ‰€ä»¥å®ƒä¸ä¼šæ”¹å˜æ—¶é—´åºåˆ—çš„æ—¶é—´ç²’åº¦ï¼Œä¹Ÿä¸ä¼šå‡å°‘æ—¶é—´ç‚¹çš„æ•°é‡ã€‚

#### âœ… 2.Â **å¸¦æ‹¬å·çš„èšåˆå‡½æ•°ï¼ˆå¦‚Â ****sum(last_4m):****ã€****avg(last_5m):****ï¼‰**

- ä½œç”¨ï¼š**åœ¨æ—¶é—´ç»´åº¦ä¸Šï¼Œå¯¹ä¸€ä¸ªæ—¶é—´åºåˆ—åœ¨æŒ‡å®šæ—¶é—´çª—å£å†…è¿›è¡Œèšåˆ**ã€‚

- èšåˆæ–¹å‘ï¼š**çºµå‘ï¼ˆæ—¶é—´èšåˆï¼‰**

- sum(last_4m):avg:system.cpu.user{host:host1,host2} â†’ å…ˆå¯¹ host1 å’Œ host2 çš„å€¼åœ¨æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šå–å¹³å‡ï¼ˆavg:ï¼‰ï¼Œç„¶ååœ¨è¿‡å» 4 åˆ†é’Ÿå†…å¯¹è¿™ä¸ªå¹³å‡å€¼åºåˆ—æ±‚å’Œï¼ˆsum(last_4m):ï¼‰ï¼Œç»“æœæ˜¯ä¸€ä¸ª**å•ä¸€å€¼**æˆ–**æ›´ä½åˆ†è¾¨ç‡çš„æ—¶é—´åºåˆ—**ã€‚

| ç‰¹æ€§ | .rollup(avg, 60) | avg(last_1m): | 
| -- | -- | -- |
| è¾“å‡ºç±»å‹ | æ—¶é—´åºåˆ— | å•ä¸€å€¼ï¼ˆæˆ–ä½é¢‘åºåˆ—ï¼‰ | 
| ç”¨é€” | å›¾è¡¨è¶‹åŠ¿ã€å¹³æ»‘ | å‘Šè­¦ã€SLOã€æ‘˜è¦ | 
| æ¯ä¸ªç‚¹çš„å«ä¹‰ | æ¯ 60 ç§’å†…çš„å¹³å‡å€¼ | å½“å‰æ—¶é—´ | 
| æ˜¯å¦è¿ç»­ | æ˜¯ | å¦ï¼ˆé€šå¸¸æ˜¯å•ç‚¹ï¼‰ | 


| è¡¨è¾¾å¼ | èšåˆæ–¹å‘ | èšåˆå¯¹è±¡ | æ˜¯å¦æ”¹å˜æ—¶é—´ç²’åº¦ | 
| -- | -- | -- | -- |
| sum:metric{...} | ç©ºé—´èšåˆï¼ˆæ¨ªå‘ï¼‰ | å¤šä¸ªæ—¶é—´åºåˆ—åœ¨åŒä¸€æ—¶é—´ç‚¹ | âŒ ä¸æ”¹å˜ | 
| sum(last_5m):metric{...} | æ—¶é—´èšåˆï¼ˆçºµå‘ï¼‰ | å•ä¸ªæ—¶é—´åºåˆ—åœ¨æ—¶é—´çª—å£å†… | âœ… æ”¹å˜ | 
| per_minute(metric{...}) | æ—¶é—´å¯¼æ•°ï¼ˆé€Ÿç‡ï¼‰+ é»˜è®¤ç©ºé—´èšåˆ | é»˜è®¤å¯¹æ‰€æœ‰åºåˆ—æ±‚å’Œ | âŒ ä¸æ”¹å˜ï¼ˆä½†æ˜¯å¯¼æ•°ï¼‰ | 
| per_minute(metric{...} by {pod_name}) | æ—¶é—´å¯¼æ•° + ä¿ç•™ç»´åº¦ | æ¯ä¸ª Pod å•ç‹¬è®¡ç®— | âŒ ä¸æ”¹å˜ | 


#### ğŸ§  å¦‚ä½•é¿å…æ··æ·†ï¼Ÿ

#### âœ… è®°ä½è¿™ä¸ªè§„åˆ™ï¼š

> **Datadog çš„å‡½æ•°å¦‚æœæ²¡æœ‰æ˜¾å¼Â ****by {tag}****ï¼Œå°±é»˜è®¤èšåˆæ‰€æœ‰åŒ¹é…çš„æ—¶é—´åºåˆ—ã€‚**


è¿™é€‚ç”¨äºï¼š

- per_minute(...)

- delta(...)

- increase(...)

- ç­‰ç­‰