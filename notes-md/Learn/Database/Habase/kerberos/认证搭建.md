好的，以下是完整的配置和脚本，帮助你连接经过 Kerberos 认证的 EMR HBase。

### 1. 配置 Kerberos KDC

#### 安装 Kerberos 包

```bash
sudo apt-get update
sudo apt-get install krb5-kdc krb5-admin-server

```

#### 配置 krb5.conf 文件(客户端和服务端)

```bash
sudo nano /etc/krb5.conf

```

添加以下内容：

```
[libdefaults]
    default_realm = EXAMPLE.COM
    dns_lookup_realm = false
    dns_lookup_kdc = false
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    EXAMPLE.COM = {
        kdc = ec2-xx-xx-xx-xx.compute-1.amazonaws.com
        admin_server = ec2-xx-xx-xx-xx.compute-1.amazonaws.com
    }

[domain_realm]
    .example.com = EXAMPLE.COM
    example.com = EXAMPLE.COM

[logging]
    default = FILE:/var/log/krb5libs.log
    kdc = FILE:/var/log/krb5kdc.log
    admin_server = FILE:/var/log/kadmind.log


```

#### 配置 kdc.conf 文件（kdc机器）

```bash
sudo nano /etc/krb5kdc/kdc.conf

```

添加以下内容：

```
[kdcdefaults]
    kdc_ports = 88
    kdc_tcp_ports = 88

[realms]
    EXAMPLE.COM = {
        database_name = /var/lib/krb5kdc/principal
        admin_keytab = /etc/krb5kdc/kadm5.keytab
        acl_file = /etc/krb5kdc/kadm5.acl
        dict_file = /usr/share/dict/words
        key_stash_file = /etc/krb5kdc/stash
        kdc_ports = 88
        kdc_tcp_ports = 88
    }
```

#### 初始化 KDC 数据库

```bash
sudo krb5_newrealm

```

#### 配置管理员权限

编辑 **/etc/krb5kdc/kadm5.acl** 文件，添加管理员权限：

```
*/admin@EXAMPLE.COM *

```

#### 启动 Kerberos 服务

```bash
sudo systemctl start krb5-kdc
sudo systemctl start krb5-admin-server
sudo systemctl enable krb5-kdc
sudo systemctl enable krb5-admin-server

```

#### 创建管理员用户

```bash
sudo kadmin.local -q "addprinc admin/admin"

```

### 2. 配置 EMR 使用外部 KDC

#### 创建安全配置

使用 AWS CLI 创建一个包含外部 KDC 信息的安全配置：

```bash
aws emr create-security-configuration --name MyKerberosConfig --security-configuration '{
  "AuthenticationConfiguration": {
    "KerberosConfiguration": {
      "Provider": "ExternalKdc",
      "ExternalKdcConfiguration": {
        "KdcHosts": ["your-kdc-host1.example.com", "your-kdc-host2.example.com"],
        "Realm": "EXAMPLE.COM"
      }
    }
  }
}'

```

#### 创建 EMR 集群

使用 AWS CLI 创建集群，并指定安全配置：

```bash
aws emr create-cluster --name "KerberosCluster" --release-label emr-6.3.0 --applications Name=Hadoop Name=Spark --use-default-roles --instance-type m5.xlarge --instance-count 3 --security-configuration MyKerberosConfig

```

### 3. 配置 HBase 使用 Kerberos

#### HBase 配置文件

在 HBase 配置文件 **hbase-site.xml** 中，设置 Kerberos 相关属性：

**XML**

```xml
<property>
  <name>hbase.security.authentication</name>
  <value>kerberos</value>
</property>
<property>
  <name>hbase.master.kerberos.principal</name>
  <value>hbase/_HOST@EXAMPLE.COM</value>
</property>
<property>
  <name>hbase.regionserver.kerberos.principal</name>
  <value>hbase/_HOST@EXAMPLE.COM</value>
</property>

```

AI-generated code. Review and use carefully. [More info on FAQ](https://www.bing.com/new#faq).

### 4. 客户端配置

#### 安装 Kerberos 客户端工具

```bash
sudo apt-get install krb5-user

```

#### 配置 krb5.conf 文件

```bash
sudo nano /etc/krb5.conf

```

添加以下内容：

```
[libdefaults]
    default_realm = EXAMPLE.COM

[realms]
    EXAMPLE.COM = {
        kdc = your-kdc-host1.example.com
        admin_server = your-kdc-host1.example.com
    }

[domain_realm]
    .example.com = EXAMPLE.COM
    example.com = EXAMPLE.COM

```

#### 创建 Linux 用户

在客户端机器上创建对应的 Linux 用户账户：

```bash
sudo useradd -m username

```

#### 获取 Kerberos 票据

用户登录后，可以使用 **kinit** 命令获取 Kerberos 票据：

```bash
kinit username@EXAMPLE.COM

```

### 5. 自动更新 Kerberos 票据

#### 编写脚本

创建一个脚本 **renew_ticket.sh** 来检查票据有效期并自动更新：

```bash
#!/bin/bash

# 检查票据有效期
if ! klist -s; then
  echo "Kerberos ticket expired, renewing..."
  kinit -kt /path/to/keytab username@EXAMPLE.COM
else
  echo "Kerberos ticket is still valid."
fi

```

确保脚本具有执行权限：

```bash
chmod +x /path/to/renew_ticket.sh

```

#### 设置 cron 作业

使用 cron 作业定期运行这个脚本：

```bash
crontab -e

```

添加以下行，每小时运行一次脚本：

```bash
0 * * * * /path/to/renew_ticket.sh
```

为了确保 Kerberos 认证的安全性和有效性，通常建议程序在生成 keytab 文件的同一用户下运行。以下是原因和一些细节：

### 为什么建议在同一用户下运行

1. 权限一致性：Kerberos 票据和 keytab 文件是为特定用户生成的，票据中的身份信息与该用户绑定。如果程序在不同用户（如 root）下运行，可能会导致权限不一致的问题。

1. 安全性：使用特定用户而不是 root 用户运行程序，可以减少潜在的安全风险。root 用户拥有系统的所有权限，任何安全漏洞都可能导致更严重的后果。

### 运行在不同用户下的可能性

虽然不建议，但在某些情况下，你可以在不同用户（如 root）下运行程序，但需要确保以下几点：

1. 正确的票据：确保在运行程序前，使用 **kinit** 命令获取正确的 Kerberos 票据。

1. 环境变量：设置正确的环境变量，使程序能够找到并使用正确的票据缓存。

### 示例：在 root 用户下运行程序

假设你已经为 **username** 用户生成了 keytab 文件，并希望在 root 用户下运行程序：

1. 获取 Kerberos 票据

： 使用 **username** 用户的 keytab 文件获取票据：

```bash
sudo -u username kinit -kt /path/to/keytab username@EXAMPLE.COM

```

1. 设置环境变量

： 确保 Kerberos 票据缓存对 root 用户可见：

```bash
export KRB5CCNAME=/tmp/krb5cc_$(id -u username)

```

1. 运行程序

： 在 root 用户下运行程序：

```bash
sudo -u root /path/to/your_application

```

### 总结

- 建议：最好在生成 keytab 文件的同一用户下运行程序，以确保权限一致性和安全性。

- 不同用户：如果必须在不同用户（如 root）下运行，确保获取正确的 Kerberos 票据并设置相应的环境变量。